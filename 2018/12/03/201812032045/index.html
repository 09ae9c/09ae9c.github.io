<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Realm 是什么？Realm is a mobile database: a replacement for SQLite &amp;amp; ORMs 特点:  Mobile-first Simple Modren Fast  从使用开始1. 配置 RealmProject 的 build.gradle 文件中添加 dependencies:123dependencies &amp;#123;       c">
<meta property="og:type" content="article">
<meta property="og:title" content="Realm Java 源码分析">
<meta property="og:url" content="http://09ae9c.com/2018/12/03/201812032045/index.html">
<meta property="og:site_name" content="09AE9C&#39;s Blog">
<meta property="og:description" content="Realm 是什么？Realm is a mobile database: a replacement for SQLite &amp;amp; ORMs 特点:  Mobile-first Simple Modren Fast  从使用开始1. 配置 RealmProject 的 build.gradle 文件中添加 dependencies:123dependencies &amp;#123;       c">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://i.loli.net/2019/01/20/5c4353fc841c6.jpg =496x136">
<meta property="og:image" content="https://i.loli.net/2019/01/20/5c4353fd8eaff.jpg =911x406">
<meta property="og:image" content="https://i.loli.net/2019/01/20/5c4353ff35b19.png =3586x1339">
<meta property="og:image" content="https://i.loli.net/2019/01/20/5c4354001c703.png =604x253">
<meta property="og:image" content="https://i.loli.net/2019/01/20/5c435401311d4.png =1481x641">
<meta property="og:updated_time" content="2019-01-19T16:44:49.416Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Realm Java 源码分析">
<meta name="twitter:description" content="Realm 是什么？Realm is a mobile database: a replacement for SQLite &amp;amp; ORMs 特点:  Mobile-first Simple Modren Fast  从使用开始1. 配置 RealmProject 的 build.gradle 文件中添加 dependencies:123dependencies &amp;#123;       c">
<meta name="twitter:image" content="https://i.loli.net/2019/01/20/5c4353fc841c6.jpg =496x136">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Realm Java 源码分析</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/09ae9c">Projects</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/12/28/201812282045/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/10/07/201810072045/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://09ae9c.com/2018/12/03/201812032045/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://09ae9c.com/2018/12/03/201812032045/&text=Realm Java 源码分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://09ae9c.com/2018/12/03/201812032045/&is_video=false&description=Realm Java 源码分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Realm Java 源码分析&body=Check out this article: http://09ae9c.com/2018/12/03/201812032045/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://09ae9c.com/2018/12/03/201812032045/&name=Realm Java 源码分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#从使用开始"><span class="toc-number">1.</span> <span class="toc-text">从使用开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-配置-Realm"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 配置 Realm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Application-中初始化"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. Application 中初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建-Model"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. 创建 Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-构建"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. 构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-增删改查"><span class="toc-number">1.0.5.</span> <span class="toc-text">5. 增删改查</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#原理分析"><span class="toc-number">2.</span> <span class="toc-text">原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基础概念"><span class="toc-number">2.1.</span> <span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ACID"><span class="toc-number">2.1.1.</span> <span class="toc-text">ACID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC"><span class="toc-number">2.1.2.</span> <span class="toc-text">MVCC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-Write-Lock"><span class="toc-number">2.1.3.</span> <span class="toc-text">Read-Write Lock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CopyOnWrite"><span class="toc-number">2.1.4.</span> <span class="toc-text">CopyOnWrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zero-copy"><span class="toc-number">2.1.5.</span> <span class="toc-text">Zero-copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schema"><span class="toc-number">2.1.6.</span> <span class="toc-text">Schema</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-层源码结构"><span class="toc-number">2.2.</span> <span class="toc-text">Java 层源码结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写入流程"><span class="toc-number">2.3.</span> <span class="toc-text">写入流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通知机制"><span class="toc-number">2.4.</span> <span class="toc-text">通知机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询流程"><span class="toc-number">2.5.</span> <span class="toc-text">查询流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程安全"><span class="toc-number">2.6.</span> <span class="toc-text">线程安全</span></a></li></ol></li>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Realm Java 源码分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">09AE9C's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-12-03T12:45:22.000Z" itemprop="datePublished">2018-12-03</time>
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Java/">Java</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Realm 是什么？<br>Realm is a mobile database: a replacement for SQLite &amp; ORMs</p>
<p>特点:</p>
<ol>
<li>Mobile-first</li>
<li>Simple</li>
<li>Modren</li>
<li>Fast</li>
</ol>
<h1 id="从使用开始"><a href="#从使用开始" class="headerlink" title="从使用开始"></a>从使用开始</h1><h3 id="1-配置-Realm"><a href="#1-配置-Realm" class="headerlink" title="1. 配置 Realm"></a>1. 配置 Realm</h3><p>Project 的 build.gradle 文件中添加 dependencies:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">       classpath &apos;io.realm:realm-gradle-plugin:5.8.0&apos;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>Module 的 build.gradle 文件中添加 plugin:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;kotlin-kapt&apos;</span><br><span class="line">apply plugin: &apos;realm-android&apos;</span><br><span class="line"># realm-android 必须添加在最后，如果使用 kotlin，还必须添加 kotlin-kapt</span><br></pre></td></tr></table></figure></p>
<h3 id="2-Application-中初始化"><a href="#2-Application-中初始化" class="headerlink" title="2. Application 中初始化"></a>2. Application 中初始化</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseApp</span> : <span class="type">Application</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        Realm.<span class="keyword">init</span>(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-创建-Model"><a href="#3-创建-Model" class="headerlink" title="3. 创建 Model"></a>3. 创建 Model</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> : <span class="type">RealmObject</span></span>() &#123;</span><br><span class="line">    <span class="meta">@PrimaryKey</span></span><br><span class="line">    <span class="keyword">var</span> id: String? = <span class="string">""</span></span><br><span class="line">    <span class="keyword">var</span> name: String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> pinyins: RealmList&lt;String&gt;? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> location: Location? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">Location</span> : <span class="type">RealmObject</span></span>() &#123;</span><br><span class="line">    <span class="keyword">var</span> province: String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> city: String? = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-构建"><a href="#4-构建" class="headerlink" title="4. 构建"></a>4. 构建</h3><p>通过 realm 的插件生成对应的代理类，生成的代码在 <code>/{module-name}/build/generated/source/kapt/debug/io/realm/</code> 目录下<br><img src="https://i.loli.net/2019/01/20/5c4353fc841c6.jpg =496x136" alt="IMAGE"></p>
<p>构建时会根据 Model 类生成对应的 RealmProxyInterface 接口和 RealmProxy 实现类<br>RealmProxyInterface 中定义 Model 的属性的 getter/setter 方法:<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">com_c9ea90_realmperformance_model_LocationRealmProxyInterface</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String realmGet$province();</span><br><span class="line">    <span class="keyword">public</span> void realmSet$province(String value);</span><br><span class="line">    <span class="keyword">public</span> String realmGet$city();</span><br><span class="line">    <span class="keyword">public</span> void realmSet$city(String value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>RealmProxy 类继承自对应的 Model 类并实现 RealmProxyInterface 和 RealmObjectProxy 接口:<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">com_c9ea90_realmperformance_model_LocationRealmProxy</span> <span class="title">extends</span> <span class="title">com</span>.<span class="title">c9ea90</span>.<span class="title">realmperformance</span>.<span class="title">model</span>.<span class="title">Location</span></span></span><br><span class="line">    implements RealmObjectProxy, com_c9ea90_realmperformance_model_LocationRealmProxyInterface &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-增删改查"><a href="#5-增删改查" class="headerlink" title="5. 增删改查"></a>5. 增删改查</h3><p>需要通过一个 Realm 实例来操作数据的增删改查，在用到的时候创建，不用的时候关闭，同一个实例不能跨线程使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建 realm 实例</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> realm = Realm.getDefaultInstance()</span><br><span class="line"></span><br><span class="line"># 关闭 realm 实例</span><br><span class="line">realm.close()</span><br></pre></td></tr></table></figure>
<p>Realm 提供了一系列方便的方法供开发者使用，比如增加或更新数据，Realm 提供三类方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">realm.creteObject()</span><br><span class="line">realm.createObjectFromJson()</span><br><span class="line">realm.createOrUpdateObjectFromJson()</span><br><span class="line"></span><br><span class="line">realm.copyToRealm()</span><br><span class="line">realm.copyToRealmOrUpdate()</span><br><span class="line"></span><br><span class="line">realm.insertToRealm()</span><br><span class="line">realm.insertOrUpdateToRealm()</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>可以直接把 Json 存到 Realm 中(内部转换成 JsonObject)，也可以直接存对应的 Model</p>
</li>
<li><p>如果存 Json，可以增量更新(如果有该字段则更新，没有该字段则不处理)，存 Model 的不能增量更新(Model 始终有默认值)</p>
</li>
<li><p>insert 和 copy 的区别在于 copy 的方式会返回对应的 RealmObject，insert 不会返回 RealmObject</p>
</li>
<li><p>对于更新操作，Model 必须要有 PrimaryKey 注解的主键字段才能使用 <code>createToRealmOrUpdate</code> 和 <code>insertOrUpdateToRealm</code>，更新是根据主键来判断是否相同</p>
</li>
</ul>
<p>Realm 的查询操作也是非常的方便</p>
<h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h3><ul>
<li>Atomicity 原子性</li>
<li>Consistency 一致性</li>
<li>Isolation 隔离性</li>
<li>Durability 持久性</li>
</ul>
<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><p>多版本并发控制，提供基于某个时间点的快照，使得对于事务看来，总是可以提供与事务开始时刻相一致的数据，类似 Git 的概念</p>
<h3 id="Read-Write-Lock"><a href="#Read-Write-Lock" class="headerlink" title="Read-Write Lock"></a>Read-Write Lock</h3><p>读写锁，多个读者可以同时读，但是读和写不能同时进行，同一时刻要么是一个写操作持有锁，要么是一个或多个读操作持有锁，Realm 提供 MVCC 的设计来解决读写锁带来的效率低的问题</p>
<h3 id="CopyOnWrite"><a href="#CopyOnWrite" class="headerlink" title="CopyOnWrite"></a>CopyOnWrite</h3><p>写时拷贝，当要修改某个元素时，不直接修改原有容器，而是先复制一份，在副本上修改，修改完成后将旧容器的指针指向新的容器</p>
<p><img src="https://i.loli.net/2019/01/20/5c4353fd8eaff.jpg =911x406" alt="IMAGE"></p>
<h3 id="Zero-copy"><a href="#Zero-copy" class="headerlink" title="Zero-copy"></a>Zero-copy</h3><p>避免数据在内核空间和用户空间进行拷贝，将文件直接映射到内存中，减少不必要的拷贝</p>
<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p>和大多数数据库中的概念差不多，是 Model 的集合，集合间没有交集，在创建 Realm 实例的时候指定对应的 modules 即可指定对应的 model 集合，集合中需要包含的 model 在 自定义 Module 中定义，这样在使用该 Realm 实例的时候就只能访问和操作该集合定义的 Model。</p>
<h2 id="Java-层源码结构"><a href="#Java-层源码结构" class="headerlink" title="Java 层源码结构"></a>Java 层源码结构</h2><p><img src="https://i.loli.net/2019/01/20/5c4353ff35b19.png =3586x1339" alt="realm-java.png"></p>
<h2 id="写入流程"><a href="#写入流程" class="headerlink" title="写入流程"></a>写入流程</h2><p>Realm 规定写入操作必须在 Transaction 中执行，一般是先调用 Realm 的 <code>beginTransaction</code> 然后紧接着执行写入操作，最后执行 <code>commitTransaction</code> 即可，通过封装的 <code>executeTransaction</code> 可以直接在回调中执行，省去了手写 begin 和 commit 的操作:</p>
<p>Realm.java<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void executeTransaction(Transaction transaction) &#123;</span><br><span class="line">    <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">    <span class="keyword">if</span> (transaction == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">"Transaction should not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    beginTransaction();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        transaction.execute(<span class="keyword">this</span>);</span><br><span class="line">        commitTransaction();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isInTransaction()) &#123;</span><br><span class="line">            cancelTransaction();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            RealmLog.warn(<span class="string">"Could not cancel transaction, not currently in a transaction."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以 <code>insertOrUpdate</code> 方法为例，通过调用 Realm 实例中的 <code>innsertOrUpdate</code> 方法执行写入操作</p>
<p>Realm.java<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void insertOrUpdate(RealmModel <span class="keyword">object</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    configuration.getSchemaMediator().insertOrUpdate(<span class="keyword">this</span>, <span class="keyword">object</span>, cache);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 Realm 中会根据创建当前实例的 Configuration 调用指定的 Mediator，默认会有一个 DefaultRealmModuleMediator 实现，如果在初始化 Realm 的时候分了 Module，则此时会用对应的 ModuleMediator 的 <code>insertOrUpdate</code> 方法</p>
<p>DefaultRealmModuleMediator.java<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> void insertOrUpdate(Realm realm, RealmModel obj, Map&lt;RealmModel, <span class="built_in">Long</span>&gt; cache) &#123;</span><br><span class="line">    <span class="comment">// This cast is correct because obj is either</span></span><br><span class="line">    <span class="comment">// generated by RealmProxy or the original type extending directly from RealmObject</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(<span class="meta-string">"unchecked"</span>)</span> Class&lt;RealmModel&gt; clazz = (Class&lt;RealmModel&gt;) ((obj instanceof RealmObjectProxy) ? obj.getClass().getSuperclass() : obj.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz.equals(com.c9ea90.realmperformance.model.Person.<span class="keyword">class</span>)) &#123;</span><br><span class="line">        io.realm.com_c9ea90_realmperformance_model_PersonRealmProxy.insertOrUpdate(realm, (com.c9ea90.realmperformance.model.Person) obj, cache);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.equals(com.c9ea90.realmperformance.model.Location.<span class="keyword">class</span>)) &#123;</span><br><span class="line">        io.realm.com_c9ea90_realmperformance_model_LocationRealmProxy.insertOrUpdate(realm, (com.c9ea90.realmperformance.model.Location) obj, cache);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> getMissingProxyClassException(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后遍历该 mediator 的集合中对应拥有的 ModelProxy 类，最终调用对应 ModelProxy 类的 <code>insertOrUpdate</code> 方法</p>
<p>io.realm.com_c9ea90_realmperformance_model_PersonRealmProxy.java<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static long insertOrUpdate(Realm realm, com.c9ea90.realmperformance.model.Person <span class="keyword">object</span>, Map&lt;RealmModel,<span class="built_in">Long</span>&gt; cache) &#123;</span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line">    Table table = realm.getTable(com.c9ea90.realmperformance.model.Person.<span class="keyword">class</span>);</span><br><span class="line">    long tableNativePtr = table.getNativePtr();</span><br><span class="line">    PersonColumnInfo columnInfo = (PersonColumnInfo) realm.getSchema().getColumnInfo(com.c9ea90.realmperformance.model.Person.<span class="keyword">class</span>);</span><br><span class="line">    long pkColumnIndex = columnInfo.idIndex;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line">    String realmGet$name = ((com_c9ea90_realmperformance_model_PersonRealmProxyInterface) <span class="keyword">object</span>).realmGet$name();</span><br><span class="line">    <span class="keyword">if</span> (realmGet$name != <span class="literal">null</span>) &#123;</span><br><span class="line">        Table.nativeSetString(tableNativePtr, columnInfo.nameIndex, rowIndex, realmGet$name, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Table.nativeSetNull(tableNativePtr, columnInfo.nameIndex, rowIndex, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">return</span> rowIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 inster 的时候，先根据对应的类名找到具体的 Table 类，然后找到对应的 ColumnInfo 类，调用 Table 的 set 方法，最终调用 native 层的写入方法，执行一次写入操作</p>
<p>写入完成后，会调用 Realm 的 <code>commitTransaction</code> 方法提交事务，最终会调用到 OsShredRealm 的 <code>nativeCommitTransaction</code> 方法来调用 native 层的代码</p>
<p>OsSharedRealm.java<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void commitTransaction() &#123;</span><br><span class="line">    nativeCommitTransaction(nativePtr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>native 层的实现在 <code>io_realm_internal_OsSharedRealm.cpp</code> 文件中</p>
<p>io_realm_internal_OsSharedRealm.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_io_realm_internal_OsSharedRealm_nativeCommitTransaction</span><span class="params">(JNIEnv* env, jclass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                                  jlong shared_realm_ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; shared_realm = *(<span class="keyword">reinterpret_cast</span>&lt;SharedRealm*&gt;(shared_realm_ptr));</span><br><span class="line">    ...</span><br><span class="line">    shared_realm-&gt;commit_transaction();</span><br><span class="line">    <span class="keyword">if</span> (!shared_realm-&gt;is_closed()) &#123;</span><br><span class="line">        shared_realm-&gt;refresh();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用了 SharedRealm 的 <code>commit_transaction</code>，在 <code>shared_realm.cpp</code> 中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Realm::commit_transaction()</span><br><span class="line">&#123; </span><br><span class="line">    ...</span><br><span class="line">    m_coordinator-&gt;commit_write(*<span class="keyword">this</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后调用 <code>m_coordinator</code> 的 <code>commit_write</code> 方法，在 <code>realm_coordinator.cpp</code> 中</p>
<p>realm_coordinator.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RealmCoordinator::commit_write(Realm&amp; realm)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    transaction::commit(*Realm::Internal::get_shared_group(realm));</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (m_notifier) &#123;</span><br><span class="line">        m_notifier-&gt;notify_others();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用 transaction 的 <code>commit()</code>，接下来就是 Realm 通知机制相关处理</p>
<h2 id="通知机制"><a href="#通知机制" class="headerlink" title="通知机制"></a>通知机制</h2><p>在提交 transaction 之后紧接着会触发 Realm 的通知流程，来告知上层监听器有变化，执行流程如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// Calling sequences for a remote commit</span><br><span class="line">// |-------------------------------+--------------+-----------------------------------|</span><br><span class="line">// | Thread A                      | Thread B     | Daemon Thread                     |</span><br><span class="line">// |-------------------------------+--------------+-----------------------------------|</span><br><span class="line">// |                               | Make changes |                                   |</span><br><span class="line">// |-------------------------------+--------------+-----------------------------------|</span><br><span class="line">// |                               |              | epoll callback and notify ALooper |</span><br><span class="line">// |-------------------------------+--------------+-----------------------------------|</span><br><span class="line">// | ALooper callback              |              |                                   |</span><br><span class="line">// | BindingContext::before_notify |              |                                   |</span><br><span class="line">// | RealmNotifier.beforeNotify    |              |                                   |</span><br><span class="line">// | BindingContext::did_change    |              |                                   |</span><br><span class="line">// | RealmNotifier.didChange       |              |                                   |</span><br><span class="line">// | process_available_async       |              |                                   |</span><br><span class="line">// | Collection listeners          |              |                                   |</span><br><span class="line">// |-------------------------------+--------------+-----------------------------------|</span><br></pre></td></tr></table></figure>
<p>执行完 commit 后，如果有 notifier，则调用它的 <code>notify_others()</code> 方法，m_notifier 是 ExtenernalCommitHelper 的实例</p>
<p>realm_coordinator.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m_notifier = std::make_unique&lt;ExternalCommitHelper&gt;(*this);</span><br></pre></td></tr></table></figure></p>
<p>ExtenernalCommitHelper 的实现根据不同系统有不同的实现，在 Android 系统中使用了 epoll 机制实现</p>
<p>epoll/extenernal_commit_helper.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void ExternalCommitHelper::notify_others()</span><br><span class="line">&#123;</span><br><span class="line">    notify_fd(m_notify_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终会触发一个后台线程的监听</p>
<p>epoll/extenernal_commit_helper.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void ExternalCommitHelper::DaemonThread::listen()</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        epoll_event ev&#123;&#125;;</span><br><span class="line">        ret = epoll_wait(m_epoll_fd, &amp;ev, 1, -1);</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            std::lock_guard&lt;std::mutex&gt; lock(m_mutex);</span><br><span class="line">            for (auto helper : m_helpers) &#123;</span><br><span class="line">                if (ev.data.u32 == (uint32_t)helper-&gt;m_notify_fd) &#123;</span><br><span class="line">                    helper-&gt;m_parent.on_change();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 helper 就是刚刚的 ExternalCommitHelper，其 <code>m_parent</code> 是之前的 RealmCoornaditor，最终触发到 RealmCoornaditor 中的 <code>on_change()</code> 方法</p>
<p>realm_coornaditor.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void RealmCoordinator::on_change()</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    run_async_notifiers();</span><br><span class="line">    </span><br><span class="line">    std::lock_guard&lt;std::mutex&gt; lock(m_realm_mutex);</span><br><span class="line">    for (auto&amp; realm : m_weak_realm_notifiers) &#123;</span><br><span class="line">        realm.notify();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中 <code>run_async_notifiers()</code> 的作用是计算数据集的改变</p>
<p>然后触发 WeakRealmNotifier 的 <code>notify()</code> 方法</p>
<p>weak_realm_notifier.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void WeakRealmNotifier::notify()</span><br><span class="line">&#123;</span><br><span class="line">    m_signal-&gt;notify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用到 <code>m_singal</code> 的 <code>notify()</code> 方法，<code>m_singal</code> 是 EventLoopSignal 的实例，其 <code>notify()</code> 的实现是:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notify</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (m_looper) &#123;</span><br><span class="line">           init();</span><br><span class="line">           notify_fd(m_message_pipe.write);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里面做了两件事，<code>init()</code> 是懒加载的初始化，初始化之后就创建了一个 ALooper，然后调用 <code>notify_fd()</code> 写入一个 1 byte 以通知 ALooper </p>
<h2 id="查询流程"><a href="#查询流程" class="headerlink" title="查询流程"></a>查询流程</h2><p>执行一段查询语句，并对结果添加监听事件<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> result = realm.<span class="keyword">where</span>(Person::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">            .findAll()</span><br><span class="line"></span><br><span class="line">result.addChangeListener &#123; t, changeSet -&gt;</span><br><span class="line">    <span class="comment">// handle changeSet</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>addChangeListener</code> 内部最终是调用了 <code>OsResult</code> 的 <code>addListener</code> 方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public &lt;T&gt; void addListener(T observer, OrderedRealmCollectionChangeListener&lt;T&gt; listener) &#123;</span><br><span class="line">    if (observerPairs.isEmpty()) &#123;</span><br><span class="line">        nativeStartListening(nativePtr);</span><br><span class="line">    &#125;</span><br><span class="line">    CollectionObserverPair&lt;T&gt; collectionObserverPair = new CollectionObserverPair&lt;T&gt;(observer, listener);</span><br><span class="line">    observerPairs.add(collectionObserverPair);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着就是调用 native 层的 nativeStartListening 方法，开始对这个数据集进行监听</p>
<p>在数据集有变化时，native 层会回调到 <code>OsResult</code> 的 <code>notifyChangeListeners</code> 方法，遍历注册的 Listener，发出通知</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// Called by JNI</span><br><span class="line">@Override</span><br><span class="line">public void notifyChangeListeners(long nativeChangeSetPtr) &#123;</span><br><span class="line">    // Object Store compute the change set between the SharedGroup versions when the query created and the latest.</span><br><span class="line">    // So it is possible it deliver a non-empty change set for the first async query returns.</span><br><span class="line">    OsCollectionChangeSet changeset = (nativeChangeSetPtr == 0)</span><br><span class="line">            ? new EmptyLoadChangeSet(null, sharedRealm.isPartial())</span><br><span class="line">            : new OsCollectionChangeSet(nativeChangeSetPtr, !isLoaded(), null, sharedRealm.isPartial());</span><br><span class="line"></span><br><span class="line">    // Happens e.g. if a synchronous query is created, a change listener is added and then</span><br><span class="line">    // a transaction is started on the same thread. This will trigger all notifications</span><br><span class="line">    // and deliver an empty changeset.</span><br><span class="line">    if (changeset.isEmpty() &amp;&amp; isLoaded()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    loaded = true;</span><br><span class="line">    observerPairs.foreach(new Callback(changeset));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是添加监听时 Java 层与 Native 层之间的调用，他们的关系是:</p>
<p><img src="https://i.loli.net/2019/01/20/5c4354001c703.png =604x253" alt="java-native-listen.png"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> ObservableCollectionWrapper&lt;Results&gt; ResultsWrapper;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_io_realm_internal_OsResults_nativeStartListening</span><span class="params">(JNIEnv* env, jobject instance,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                              jlong native_ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">auto</span> wrapper = <span class="keyword">reinterpret_cast</span>&lt;ResultsWrapper*&gt;(native_ptr);</span><br><span class="line">        wrapper-&gt;start_listening(env, instance);</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>nativeStartListening</code> 的 native 实现中，调用了 <code>ResultsRwapper</code> 的 <code>start_listening()</code> 方法</p>
<p>observable_collection_wrapper.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  T m_collection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ObservableCollectionWrapper&lt;T&gt;::start_listening(JNIEnv* env, jobject j_collection_object)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> jni_util::<span class="function">JavaClass <span class="title">os_results_class</span><span class="params">(env, <span class="string">"io/realm/internal/ObservableCollection"</span>)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> jni_util::<span class="function">JavaMethod <span class="title">notify_change_listeners</span><span class="params">(env, os_results_class, <span class="string">"notifyChangeListeners"</span>, <span class="string">"(J)V"</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    m_notification_token = m_collection.add_notification_callback(cb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里首先找到 Java 层的 <code>ObservableCollection</code> 中的 <code>notifyChangeListeners</code> 方法，然后放到 <code>callback</code> 中<br>最后把 <code>callback</code> 添加到 <code>collection</code> 的 <code>notification_callback</code> 中</p>
<p>results.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void Results::prepare_async(ForCallback force)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    m_notifier = std::make_shared&lt;_impl::ResultsNotifier&gt;(*this);</span><br><span class="line">    _impl::RealmCoordinator::register_notifier(m_notifier);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">NotificationToken Results::add_notification_callback(CollectionChangeCallback cb) &amp;</span><br><span class="line">&#123;</span><br><span class="line">    prepare_async(ForCallback&#123;true&#125;);</span><br><span class="line">    return &#123;m_notifier, m_notifier-&gt;add_callback(std::move(cb))&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 <code>prepare_async()</code> 中，创建对应的 ResultsNotifier 实例，在 ResultsNotifier 构造方法里面获取当前 Result，从而拿到对应的 Table</p>
<p>realm_coordinator.cpp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void RealmCoordinator::register_notifier(std::shared_ptr&lt;CollectionNotifier&gt; notifier)</span><br><span class="line">&#123;</span><br><span class="line">    auto version = notifier-&gt;version();</span><br><span class="line">    auto&amp; self = Realm::Internal::get_coordinator(*notifier-&gt;get_realm());</span><br><span class="line">    &#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(self.m_notifier_mutex);</span><br><span class="line">        self.pin_version(version);</span><br><span class="line">        self.m_new_notifiers.push_back(std::move(notifier));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ResultsNotifier 继承自 CollectionNotifier，调用了 CollectionNotifier 的 add_callback<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">uint64_t CollectionNotifier::add_callback(CollectionChangeCallback callback)</span><br><span class="line">&#123;</span><br><span class="line">    m_realm-&gt;verify_thread();</span><br><span class="line"></span><br><span class="line">    std::lock_guard&lt;std::mutex&gt; lock(m_callback_mutex);</span><br><span class="line">    auto token = m_next_token++;</span><br><span class="line">    m_callbacks.push_back(&#123;std::move(callback), &#123;&#125;, &#123;&#125;, token, false, false&#125;);</span><br><span class="line">    if (m_callback_index == npos) &#123; // Don&apos;t need to wake up if we&apos;re already sending notifications</span><br><span class="line">        Realm::Internal::get_coordinator(*m_realm).wake_up_notifier_worker();</span><br><span class="line">        m_have_callbacks = true;</span><br><span class="line">    &#125;</span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用到 RealmCoornaditor 的 <code>wake_up_notifier_worker()</code> 方法</p>
<p>realm_coornaditor.cpp<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> RealmCoordinator::wake_up_notifier_worker()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_notifier) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">FIXME:</span> this wakes up the notification workers for all processes and</span></span><br><span class="line">        <span class="comment">// not just us. This might be worth optimizing in the future.</span></span><br><span class="line">        m_notifier-&gt;notify_others();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来就跟前面写操作之后的通知一样了，调用 notifier 的 <code>notify_others()</code> </p>
<p><img src="https://i.loli.net/2019/01/20/5c435401311d4.png =1481x641" alt="realm-cpp.png"></p>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p>Realm 不支持跨线程访问，原因是他的 MVCC 的特点，同一个线程中同时只能有一个写操作，但可以多个线程独立的写，最后再合到主分支上</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/09ae9c">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#从使用开始"><span class="toc-number">1.</span> <span class="toc-text">从使用开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-配置-Realm"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 配置 Realm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Application-中初始化"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. Application 中初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-创建-Model"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. 创建 Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-构建"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. 构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-增删改查"><span class="toc-number">1.0.5.</span> <span class="toc-text">5. 增删改查</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#原理分析"><span class="toc-number">2.</span> <span class="toc-text">原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基础概念"><span class="toc-number">2.1.</span> <span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ACID"><span class="toc-number">2.1.1.</span> <span class="toc-text">ACID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC"><span class="toc-number">2.1.2.</span> <span class="toc-text">MVCC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-Write-Lock"><span class="toc-number">2.1.3.</span> <span class="toc-text">Read-Write Lock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CopyOnWrite"><span class="toc-number">2.1.4.</span> <span class="toc-text">CopyOnWrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zero-copy"><span class="toc-number">2.1.5.</span> <span class="toc-text">Zero-copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schema"><span class="toc-number">2.1.6.</span> <span class="toc-text">Schema</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-层源码结构"><span class="toc-number">2.2.</span> <span class="toc-text">Java 层源码结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写入流程"><span class="toc-number">2.3.</span> <span class="toc-text">写入流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通知机制"><span class="toc-number">2.4.</span> <span class="toc-text">通知机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询流程"><span class="toc-number">2.5.</span> <span class="toc-text">查询流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程安全"><span class="toc-number">2.6.</span> <span class="toc-text">线程安全</span></a></li></ol></li>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://09ae9c.com/2018/12/03/201812032045/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://09ae9c.com/2018/12/03/201812032045/&text=Realm Java 源码分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://09ae9c.com/2018/12/03/201812032045/&is_video=false&description=Realm Java 源码分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Realm Java 源码分析&body=Check out this article: http://09ae9c.com/2018/12/03/201812032045/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://09ae9c.com/2018/12/03/201812032045/&title=Realm Java 源码分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://09ae9c.com/2018/12/03/201812032045/&name=Realm Java 源码分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 09AE9C
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/09ae9c">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


